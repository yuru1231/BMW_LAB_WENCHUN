#  Task2: UT Serving Satellite & Handover 

## Objective
Verify that a UT (User Terminal) is **not permanently served by a single satellite**, and that **serving satellite handovers occur due to LEO movement**, under a realistic elevation availability constraint.

This milestone covers:
- Serving Satellite Tracking**
- Handover Detection**

---

### 0. Experimental Setup

### 0.1 Fixed Inputs
- **LEO position trace**  
  `docs/data/task2_d3d4/input/leo_positions_N66_T7200_S10.csv`  
  (Generated by `sat-leo-positions-minimal`, `nSats=66`, `simLength=7200s`, `stepSec=10s`)

- **UT location**
  - Latitude: `25.0330`
  - Longitude: `121.5654` (Taipei)

- **Availability threshold**
  - `ELEV_MIN_DEG = 10.0`

---

### 0.2 Procedure (Reproducible)

```bash
export ROOT="$HOME/beam_hopping/leo_minimal"
export OUT="$ROOT/d3d4_final"

cd "$ROOT/d3d4_precheck/out"
python3 ut_serving_precheck_lla_full.py \
  "$OUT/input/leo_positions_N66_T7200_S10.csv" \
  | tee "$OUT/logs/run_d3d4.log"
```
outputs:
- served_sat_timeseries.csv
- handover_events.csv
- max_elevation_per_time.csv

## 1. Serving Satellite Tracking
### 1.1 Metrics
- Coverage Ratio：`0.608`
- Unique servedSatId（exclude -1）：`49`

### 1.2 Interpretation
- 在 `ELEV_MIN = 10°` 的條件下，UT 約有 60.8% 的時間能被服務
- UT 曾由 49 顆不同衛星提供服務，顯示服務衛星會隨時間變化，而非固定不變。

## 2. Handover Detection
### 2.1 Metrics
- Overlap Ratio（numCandidates ≥ 2）：`0.578`
- Total handovers（含 -1 ↔ sat）：`50`
- Satellite-to-Satellite Handovers：`47`

### 2.2 Interpretation
- 超過一半的時間點存在 多顆可服務衛星重疊。
- 共偵測到 47 次 sat-to-sat handover，證明 UT 的服務會在不同衛星之間切換，而非單純進出覆蓋區。

## 3 SOP
### 3.1 Directory Setup
```
export ROOT="$HOME/beam_hopping/leo_minimal"
mkdir -p "$ROOT/d3d4_precheck/input"
mkdir -p "$ROOT/d3d4_precheck/out"
mkdir -p "$ROOT/d3d4_precheck/logs"
```
### 3.2 Generate
#### 3.2.1 Generate LEO Position Trace
```
./ns3 run "sat-leo-positions-minimal \
  --nSats=66 \
  --altM=600000 \
  --incDeg=53 \
  --simLength=7200 \
  --stepSec=10 \
  --outCsv=$ROOT/d3d4_precheck/input/leo_positions_N66_T7200_S10.csv"
```
#### 3.2.2 UT Coverage & Handover Precheck
```
export POS="$ROOT/d3d4_precheck/input/leo_positions_N66_T7200_S10.csv"

cd "$ROOT/d3d4_precheck/out"
python3 ut_serving_precheck_lla_full.py "$POS"
```
output
```
Times: 720
Coverage points: 438 / 720 (ratio=0.608) using ELEV_MIN_DEG=10.0
served_sat_timeseries.csv rows: 720
handover_events.csv rows: 50
Wrote: served_sat_timeseries.csv, handover_events.csv, max_elevation_per_time.csv
```
## 4 Quantitative Checks
### 4.1 Coverage Ratio
```
awk -F, 'NR>1{tot++; if($3!=-1)cov++} \
END{print "coverage_ratio=",(tot?cov/tot:0)}' served_sat_timeseries.csv
```
output
```
coverage_ratio= 0.608333
```
### 4.2 Overlap Ratio
```
awk -F, 'NR>1{tot++; if($6>=2)ov++} \
END{print "overlap_ratio=",(tot?ov/tot:0)}' served_sat_timeseries.csv
```
output
```
overlap_ratio= 0.577778
```
### 4.3 Satellite-to-Satellite Handover
```
awk -F, 'NR==1 || ($3!=-1 && $4!=-1)' \
handover_events.csv > handover_events_sat2sat.csv
```
output
```
=== line count ===
48 handover_events_sat2sat.csv
=== head ===
time,utId,oldSatId,newSatId,reason
2950.0,0,57,56,max_elevation_changed
3040.0,0,56,55,max_elevation_changed
3130.0,0,55,54,max_elevation_changed
3220.0,0,54,53,max_elevation_changed
3320.0,0,53,52,max_elevation_changed
...
=== tail ===
...
6910.0,0,14,13,max_elevation_changed
7010.0,0,13,12,max_elevation_changed
7100.0,0,12,11,max_elevation_changed
7190.0,0,11,10,max_elevation_changed
```
## 5 Decision Rules
|狀態|	說明|
|-|-|
|coverage_ratio = 0|	UT 完全無覆蓋，需增加 nSats 或調整門檻|
|overlap_ratio = 0|	無重疊，無法形成 sat-to-sat HO|
|sat_to_sat_handovers > 0	|真正的 handover 成立|

## 6 Python
[ut_serving_precheck_lla_full.py](https://github.com/bmw-ntust-internship/Lucy/blob/d423d14bbd9ae9ab843815d35fee46034b7e3b79/codes/ut_serving_precheck_lla_full)

### 6.1 Serving Satellite Tracking
#### 6.1.1 Input:
- 每個時間點的所有衛星 LLA（lat/lon/alt）
- positions trace:`leo_positions_N66_T7200_S10.csv`
  ```
  time,satId,lat,lon,alt
  ``` 
#### 6.1.2 Output:
- 每個時間點 UT 被哪顆衛星服務 `servedSatId`，以及當下候選衛星數 ` numCandidates `
>對每個時間點，計算 UT 與每顆衛星的 仰角 elevation，挑出` elev >= ELEV_MIN_DEG `的候選；若候選非空，選擇 仰角最大 的衛星當 serving satellite。
```
time：秒
utId：目前只做 1 個 UT，通常是 0
servedSatId：被服務衛星 id；若無覆蓋 → -1
elev_deg：被選中 serving sat 的仰角（deg）；若無覆蓋 → nan
dist_km：UT 到 serving sat 的距離（km）；若無覆蓋 → nan
numCandidates：符合 elev>=ELEV_MIN_DEG 的衛星數
檢查：
coverage_ratio：看 $3 != -1
overlap_ratio：看 $6 >= 2
```
### 6.2 Handover Detection
#### 6.2.1:
在 `servedSatId(t) `序列上做 event detection：
若 `servedSatId(t)` 與上一個時間點不同，就記錄一筆 handover event：
`(time, oldSatId, newSatId, reason=max_elevation_changed)`
\
\
再進一步分離：
coverage acquisition/loss：`-1 ↔ satId`
sat-to-sat handover：`satIdA → satIdB`（old/new 都不是 -1）
#### 6.2.2 parameters
`handover_events.csv`:
- time
- utId
- oldSatId
- newSatId
- reason：目前固定 max_elevation_changed

`max_elevation_per_time.csv`
- time
- bestSatId：該時間點仰角最大的衛星（不管有沒有達門檻）
- maxElev_deg
- dist_km\
用途：判斷「為什麼 coverage 會是 0」
- 若 maxElev 常常小於 10° → 門檻太高或星座太稀
- 若 maxElev 很高但仍無候選 → 代表仰角計算或篩選條件有 bug（通常不會）

### 6.3 Algorithm / Dataflow
以time作為標的作為流程
#### 6.3.1 讀 CSV 並依 time 分組
`positions_by_time[t] = [(satId, lat, lon, alt), ...]`
同一個 time 會有 N 顆衛星行 `N=66`

#### 6.3.2 針對該時間點計算 UT 與每顆衛星的仰角
仰角（elevation）計算通常由以下幾步構成：
1. 將 UT 位置（lat/lon/alt）轉成 ECEF 向量 r_ut
2. 將衛星位置（lat/lon/alt）轉成 ECEF 向量 r_sat
3. 得到 LOS 向量：v = r_sat - r_ut
4. 以 UT 當地的「天頂方向」（local up）作投影，算出 elevation：
- elevation = angle between v and local horizontal plane
- 等價：elev = 90° - zenith_angle

#### 6.3.3 Coverage candidates
過濾：
- candidates = {sat | elev_deg >= ELEV_MIN_DEG}

記錄：
`numCandidates = len(candidates)`
#### 6.3.4 serving satellite
if \
candidates 為空：
- `servedSatId = -1`
- `elev_deg = nan`
- `dist_km = nan`

else \
- 選擇 elev_deg 最大的那顆（max elevation）
- servedSatId = argmax elev
handover event 的 reason=max_elevation_changed：
服務切換策略就是“最大仰角優先”

#### 6.3.5 Handover event detection
維護上一個時間點的 prevServedSatId：
- 若 servedSatId != prevServedSatId：
  - 紀錄 handover_events.csv 一筆
  - (time, utId, old=prev, new=current, reason)
並更新 prev。

### 6.4 Result
在 `nSats=66 `下得到：
- coverage_ratio = 0.608
- overlap_ratio = 0.578
- sat_to_sat_handovers = 47
- unique_servedSatId = 49

- 覆蓋不再是零星，UT 具備大量可視衛星機會
- 多數時間點有 ≥2 顆候選（因此 sat-to-sat handover 會大量發生）
- unique_servedSatId 很高，符合 LEO 星座下 serving sat 會頻繁更的直覺
- sat-to-sat handover 幾乎占 total handovers（47/50），說明大部分變化來自衛星間切換，而非單純進出覆蓋

## 7 Improve
### 7.1 Problem
handover rule 是「最大仰角立即切換」，容易造成：
- ping-pong（仰角接近時反覆切換）
- -1 斷點（門檻邊緣進出覆蓋）
### 7.2 Function
1.Hysteresis（切換滯後）：新衛星仰角需比舊衛星高 Δ 才切換（例如 2°）\
2.Minimum dwell time（最短駐留時間）：每次切換後至少維持 30s 才允許再切 \
3.Hold-on-loss（短暫失覆蓋保持）：允許短時間（例如 1~2 step）保留 prev sat 避免 -1
